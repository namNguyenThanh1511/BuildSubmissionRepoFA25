using Repository.Models;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.Extensions.Configuration;
using Repository.IRepository;

namespace Service
{
    public class AuthService : IAuthService
    {
        private readonly IAuthRepository _authRepository;
        private readonly string _jwtKey;
        private readonly string _jwtIssuer;
        private readonly Dictionary<int, string> _roleMap = new()
        {
            { 1, "admin" },
            { 2, "manager" },
            { 3, "staff" },
            { 4, "member" },
            { 5, "administrator" },
            { 6, "moderator" },
            { 7, "developer" }
        };

        public AuthService(IAuthRepository authRepository, IConfiguration config)
        {
            _authRepository = authRepository;
            _jwtKey = config["Jwt:Key"] ?? "default_secret_key";
            _jwtIssuer = config["Jwt:Issuer"] ?? "default_issuer";
        }

        public (string? Token, string? Role) Authenticate(string email, string password)
        {
            var account = _authRepository.GetAccountByEmailAndPassword(email, password);
            if (account == null || account.RoleId == null || !_roleMap.ContainsKey(account.RoleId.Value))
                return (null, null);

            var role = _roleMap[account.RoleId];
            if (role != "administrator" && role != "moderator" && role != "developer" && role != "member")
                return (null, null);

            if (role == "administrator" || role == "moderator" || role == "developer" || role == "member")
            {
                var claims = new[]
                {
                    new Claim(JwtRegisteredClaimNames.Sub, account.Email),
                    new Claim("role", role)
                };
                var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_jwtKey));
                var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
                var token = new JwtSecurityToken(
                    issuer: _jwtIssuer,
                    audience: _jwtIssuer,
                    claims: claims,
                    expires: DateTime.Now.AddHours(2),
                    signingCredentials: creds
                );
                var jwt = new JwtSecurityTokenHandler().WriteToken(token);
                return (jwt, role);
            }
            return (null, null);
        }
    }
}
