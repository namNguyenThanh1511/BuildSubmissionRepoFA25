name: Build Student Submissions

on:
  push:
    branches:
      - main
      - master
    paths:
      - "submissions/**"

jobs:
  build-submissions:
    runs-on: ubuntu-latest

    steps:
      - name: Enable Git long paths
        run: git config --system core.longpaths true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for git diff

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Identify changed submission folders
        id: changed-folders
        run: |
          # Get list of changed files in submissions/
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^submissions/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes in submissions folder"
            echo "folders=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique folder names (format: submissions/StudentId-Timestamp-Index/)
          FOLDERS=$(echo "$CHANGED_FILES" | sed 's|submissions/\([^/]*\)/.*|\1|' | sort -u)

          # Convert to JSON array
          FOLDER_JSON=$(echo "$FOLDERS" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "folders=$FOLDER_JSON" >> $GITHUB_OUTPUT
          echo "Found folders: $FOLDERS"

      - name: Build each changed submission
        if: steps.changed-folders.outputs.folders != '[]'
        run: |
          FOLDERS='${{ steps.changed-folders.outputs.folders }}'

          # Parse JSON array and build each folder
          echo "$FOLDERS" | jq -r '.[]' | while read -r folder; do
            SUBMISSION_PATH="submissions/$folder"
            
            if [ ! -d "$SUBMISSION_PATH" ]; then
              echo "âš ï¸ Folder $SUBMISSION_PATH does not exist, skipping..."
              continue
            fi
            
            echo "ðŸ”¨ Building submission: $folder"
            echo "ðŸ“ Path: $SUBMISSION_PATH"
            
            # Find .sln or .csproj files
            SOLUTION_FILE=$(find "$SUBMISSION_PATH" -name "*.sln" -type f | head -n 1)
            PROJECT_FILE=$(find "$SUBMISSION_PATH" -name "*.csproj" -type f | head -n 1)
            
            if [ -n "$SOLUTION_FILE" ]; then
              BUILD_TARGET="$SOLUTION_FILE"
              echo "âœ… Found solution file: $SOLUTION_FILE"
            elif [ -n "$PROJECT_FILE" ]; then
              BUILD_TARGET="$PROJECT_FILE"
              echo "âœ… Found project file: $PROJECT_FILE"
            else
              echo "âŒ No .sln or .csproj found in $SUBMISSION_PATH"
              echo "::error::No build target found for $folder"
              continue
            fi
            
            # Build the project
            echo "ðŸš€ Starting build for $folder..."
            if dotnet build "$BUILD_TARGET" -c Release --no-restore; then
              echo "âœ… Build succeeded for $folder"
              echo "::notice::Build succeeded for $folder"
            else
              echo "âŒ Build failed for $folder"
              echo "::error::Build failed for $folder"
              exit 1
            fi
            
            echo "---"
          done

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build process completed for all changed submissions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed results." >> $GITHUB_STEP_SUMMARY
